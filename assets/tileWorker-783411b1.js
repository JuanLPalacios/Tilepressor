(function(){"use strict";function C(t,r,a){const n=(t-r)/255,e=n+a;return Math.max(n*n,e*e)}function N(t,r){return t?r?t.map((a,n)=>Math.round((a+r[n])/2)):t:r}function R(t,r){return[t,r]}function E(t,[r,a]){const n=Array.from(t).fill(0);for(let e=0;e<r.length;e++){const o=r[e],s=a[e],c=t[e];n[e]+=(c*(o-s)+.5*(s*s-o*o))/2}return n.reduce((e,o)=>e+o,0)>0}function x(t,r,a,n){if(t.length<=1||t.length>256)return null;let e=Number.MAX_VALUE,o=[],s=[],c,g,f;for(let i=0;i<t.length;i++){const u=t[i];for(let d=i+1;d<t.length;d++){const p=t[d],B=r(u,p),F=[],j=[];t.forEach(S=>{a(S,B)?F.push(S):j.push(S)});const k=F.length-j.length;if(e>k&&(c=B,e=k,o=F,s=j,g=u,f=p),e==0)break}if(e==0)break}const h={divider:c,front:g,back:f,inFront:x(o,r,a,n&&(i=>n(i*o.length/t.length))),inBack:x(s,r,a,n&&(i=>n((o.length+i*s.length)/t.length)))};return n&&n(1),h}function m(t,r,a){return r===null?t:a(t,r.divider)?r.inFront?m(t,r.inFront,a):r.front:r.inBack?m(t,r.inBack,a):r.back}function M({data:t,raw:r,instances:a},n){const e=[];for(let o=0;o<t.length;o+=4)e.push(...n(t.slice(o,o+3))),e.push(t[o+3]);return{data:e,instances:a,raw:r}}function A(t,r,a,n,e){if(t.length==0||t.length<=r)return t;let o={tile:t[0],points:t};const s=[o];for(let c=1;c<r;c++){e&&e(c/r);let g=0,f=o.tile;for(let h=0;h<s.length;h++){const i=s[h];for(let u=0;u<i.points.length;u++){const d=i.points[u],p=a(i.tile,d);p>g&&(f=d,g=p)}}o={tile:f,points:[]},s.unshift(o);for(let h=1;h<s.length;h++){const i=s[h];for(let u=0;u<i.points.length;u++){const d=i.points[u],p=a(o.tile,d);a(i.tile,d)>p&&(o.points.push(d),i.points.splice(u,1),u--)}}}for(let c=0;c<s.length;c++){const g=s[c];g.points.length!=1&&(g.tile=g.points.reduce((f,h)=>n(f,h)))}return s.map(c=>c.tile)}function _(t,r){let a=0;for(let n=0;n<t.data.length;n+=4){const e=(t.data[n+3]-r.data[n+3])/255;a+=C(t.data[n],r.data[n],e)+C(t.data[n+1],r.data[n+1],e)+C(t.data[n+2],r.data[n+2],e)}return a}function y(t,r){return _(t,r)*(t.instances.length+r.instances.length)}const W=(t,r)=>Math.sqrt(t.reduce((a,n,e)=>a+(n-r[e])**2,0));function z(t,r){if(!t)return r;if(!r)return t;const a={data:Array.from(t.data),instances:[],raw:[...t.raw]},n=t.instances.length+r.instances.length;for(let e=0;e<t.data.length;e++)a.data[e]=(t.data[e]*t.instances.length+r.data[e]*r.instances.length)/n;for(let e=0;e<t.data.length;e++)a.raw[e]=Math.min(Math.floor((t.raw[e]*t.instances.length+r.raw[e]*r.instances.length)/n),255);return a.instances.push(...t.instances),a.instances.push(...r.instances),a}function Q(t){const r={};for(let a=0;a<t.length;a++){const n=t[a];for(let e=0;e<n.data.length;e+=4){let o=n.data.slice(e,e+4);o[3]==0&&(o=[0,0,0,0]),r[o.toString()]=o}}return Object.values(r)}function U(t,r){const{raw:a}=t,n=Array.from(a);for(let e=0;e<n.length;e+=4){const o=m(n.slice(e,e+4),r,E);for(let s=0;s<4;s++)a[e+s]=o[s]}}function H(t,r){let a=0;const n=Math.sqrt(t.data.length/4);b[n]||(b[n]=G(n));for(let e=0;e<t.data.length;e+=4)a+=W(t.data.slice(e,e+4),r.data.slice(e,e+4))/b[n][e/4];return a}function L(t,r){return H(t,r)*(t.instances.length+r.instances.length)}const I=t=>t==0?1:Math.sqrt(2);function V(t){const r=Array.from(t).fill(0),{PI:a}=Math,n=Math.sqrt(t.length/4);for(let e=0;e<r.length;e+=4){const o=e/4%n,s=Math.floor(e/4/n);for(let c=0;c<4;c++){let g=0;for(let f=0;f<t.length;f+=4){const h=f/4%n,i=Math.floor(f/4/n);g+=t[f+c]*Math.cos((2*h+1)*o*a/(2*n))*Math.cos((2*i+1)*s*a/(2*n))}r[e+c]=I(o)*I(s)*g/n}}return r}function X(t){const r=Array.from(t).fill(0),{PI:a}=Math,n=Math.sqrt(t.length/4);for(let e=0;e<r.length;e+=4){const o=e/4%n,s=Math.floor(e/4/n);for(let c=0;c<4;c++){let g=0;for(let f=0;f<t.length;f+=4){const h=f/4%n,i=Math.floor(f/4/n);g+=t[f+c]*Math.cos(2*h*o*a/(2*n))*Math.cos(2*i*s*a/(2*n))}r[e+c]=g/n}}return r}function G(t){const r=t*t;let a=[0];for(;a.length<r;)a.push(...a);a=a.slice(0,r);for(let n=0;n<r;n++){const e=n%t,o=Math.floor(n/t);a[o*t+e]=(Math.max(e,o)+1)**2}return a}const b=[];var O=function(r){var a=(r[0]+16)/116,n=r[1]/500+a,e=a-r[2]/200,o,s,c;return n=.95047*(n*n*n>.008856?n*n*n:(n-16/116)/7.787),a=1*(a*a*a>.008856?a*a*a:(a-16/116)/7.787),e=1.08883*(e*e*e>.008856?e*e*e:(e-16/116)/7.787),o=n*3.2406+a*-1.5372+e*-.4986,s=n*-.9689+a*1.8758+e*.0415,c=n*.0557+a*-.204+e*1.057,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:12.92*o,s=s>.0031308?1.055*Math.pow(s,1/2.4)-.055:12.92*s,c=c>.0031308?1.055*Math.pow(c,1/2.4)-.055:12.92*c,[Math.max(0,Math.min(1,o))*255,Math.max(0,Math.min(1,s))*255,Math.max(0,Math.min(1,c))*255]},q=function(r){var a=r[0]/255,n=r[1]/255,e=r[2]/255,o,s,c;return a=a>.04045?Math.pow((a+.055)/1.055,2.4):a/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,o=(a*.4124+n*.3576+e*.1805)/.95047,s=(a*.2126+n*.7152+e*.0722)/1,c=(a*.0193+n*.1192+e*.9505)/1.08883,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,c=c>.008856?Math.pow(c,1/3):7.787*c+16/116,[116*s-16,500*(o-s),200*(s-c)]},D=(t=>(t[t.Raster=0]="Raster",t[t.CDT=1]="CDT",t))(D||{}),l=(t=>(t[t.kMeansPlusPlus=0]="kMeansPlusPlus",t[t.pixels2dct=1]="pixels2dct",t[t.cdt2pixels=2]="cdt2pixels",t[t.rgb2lab=3]="rgb2lab",t[t.lab2rgb=4]="lab2rgb",t[t.applyFilter=5]="applyFilter",t[t.generateBSPT=6]="generateBSPT",t[t.cleanCache=7]="cleanCache",t[t.getColors=8]="getColors",t))(l||{});self.onmessage=t=>{const{action:r}=t.data;switch(r){case l.applyFilter:return tt(t.data);case l.kMeansPlusPlus:return K(t.data);case l.pixels2dct:return Z(t.data);case l.cdt2pixels:return Y(t.data);case l.generateBSPT:return et(t.data);case l.lab2rgb:return T(t.data);case l.rgb2lab:return $(t.data);case l.cleanCache:return nt();case l.getColors:return J(t.data)}};const w={};function J({props:{tiles:t},id:r}){const a=t.toString(),n=w[a];if(n)return self.postMessage({id:r,action:l.getColors,data:{colors:n},progress:1});let e=Q(t);e=A(e,256,W,N,o=>{self.postMessage({id:r,action:l.getColors,data:{},progress:o})}),w[a]=e,self.postMessage({id:r,action:l.getColors,data:{colors:e},progress:1})}function K({props:{tiles:t,k:r,colorModel:a,tileModel:n},id:e}){const{distanceFunc:o,centroidFunc:s}=rt(a,n);t=A(t,r,o,s,c=>{self.postMessage({id:e,action:l.kMeansPlusPlus,data:{},progress:c})}),self.postMessage({id:e,action:l.kMeansPlusPlus,data:{tiles:t},progress:1})}function Y({props:{tiles:t},id:r}){t.forEach((a,n)=>{n%10==0&&self.postMessage({id:r,action:l.cdt2pixels,data:{},progress:n/t.length}),a.data=X(a.data),a.data=M(a,O).data}),self.postMessage({id:r,action:l.cdt2pixels,data:{tiles:t},progress:1})}const P={};function Z({props:{tiles:t},id:r}){const a=t.toString(),n=P[a];if(n)return self.postMessage({id:r,action:l.pixels2dct,data:{tiles:n},progress:1});t.forEach((e,o)=>{o%10==0&&self.postMessage({id:r,action:l.pixels2dct,data:{},progress:o/t.length});const s=V(M(e,q).data);e.data=s}),P[a]=t,self.postMessage({id:r,action:l.pixels2dct,data:{tiles:t},progress:1})}const v={};function $({props:{tiles:t},id:r}){const a=t.toString(),n=v[a];if(n)return self.postMessage({id:r,action:l.rgb2lab,data:{tiles:n},progress:1});t.forEach((e,o)=>{o%10==0&&self.postMessage({id:r,action:l.rgb2lab,data:{},progress:o/t.length});const s=M(e,q).data;e.data=s}),v[a]=t,self.postMessage({id:r,action:l.rgb2lab,data:{tiles:t},progress:1})}function T({props:{tiles:t},id:r}){t.forEach((a,n)=>{n%10==0&&self.postMessage({id:r,action:l.lab2rgb,data:{},progress:n/t.length}),a.data=M(a,O).data}),self.postMessage({id:r,action:l.lab2rgb,data:{tiles:t},progress:1})}function tt({props:{tiles:t,bspt:r},id:a}){t.forEach((n,e)=>{U(n,r||null),self.postMessage({id:a,action:l.applyFilter,data:{},progress:e/t.length})}),self.postMessage({id:a,action:l.applyFilter,data:{tiles:t},progress:1})}function et({props:{colors:t},id:r}){const a=x(Object.values(t.reduce((n,e)=>({...n,[e.toString()]:e}),{})),R,E,n=>n!=1&&self.postMessage({id:r,action:l.generateBSPT,data:{},progress:n}));self.postMessage({id:r,action:l.generateBSPT,data:{bspt:a},progress:1})}function nt(){[v,P,w].forEach(r=>{Object.keys(r).forEach(a=>{delete r[a]})})}function rt(t,r){return{centroidFunc:z,distanceFunc:{[D.CDT]:L,[D.Raster]:y}[r]}}})();
